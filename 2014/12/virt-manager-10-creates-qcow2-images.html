<!DOCTYPE html>
<!-- Generated 2020-09-16 14:58:31.424383 -->
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-142995745-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-142995745-1');
    </script>
    <link rel="canonical" href="https://blog.wikichoon.com/2014/12/virt-manager-10-creates-qcow2-images.html"/>
      <title>virt-manager 1.0 creates qcow2 images that don't work on RHEL6 | Cole Robinson</title>
      <meta charset="utf-8" />
      <link href="https://blog.wikichoon.com/theme/minima-main.css" rel="stylesheet" />
      <link href="https://blog.wikichoon.com/theme/coletheme.css" rel="stylesheet" />
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://blog.wikichoon.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cole Robinson Full Atom Feed" />
  </head>

  <body id="index" class="archive">
    <header class="site-header">
      <div class="wrapper">
        <a class="site-title" href="https://blog.wikichoon.com">Cole Robinson</a>
        <nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
          <div class="trigger">
            <a class="page-link" href="https://blog.wikichoon.com">Home</a>
            <a class="page-link" href="https://blog.wikichoon.com/archives.html">Archives</a>
            <a class="page-link" href="https://wikichoon.com">About</a>
          </div>
        </nav>
      </div>
    </header>

    <main id="content" class="page-content">
      <div class="wrapper">
      <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
        <header>
          <h1 class="post-title givemecolor" itemprop="name headline">virt-manager 1.0 creates qcow2 images that don't work on RHEL6</h2>
          <p class="post-meta">
            <time class="dt-published" datetime="2014-12-05T09:09:00-05:00" itemprop="datePublished">Fri 05 December 2014
            </time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Cole Robinson</span>
            </span> • Tags: <a href="https://blog.wikichoon.com/tag/fedora.html">fedora</a> <a href="https://blog.wikichoon.com/tag/virt.html">virt</a>           </p>
        </header>

        <div class="post-content" itemprop="articleBody">
          <p>One of the big features we added in virt-manager 1.0 was <a href="https://blog.wikichoon.com/2014/03/snapshot-support-in-virt-manager.html">snapshot support</a>. As part of this change, we switched to using the QCOW2 disk image format for new VMs. We also enable the <a href="https://lists.gnu.org/archive/html/qemu-devel/2012-06/msg03827.html">QCOW2 lazy_refcounts</a> feature that improves performance of some snapshot operations.</p>
<p>However, not all versions of QEMU in the wild can handle lazy_refcounts, and will refuse to use the disk image, particularly RHEL6 QEMU. So by default, a disk image from a VM created with Fedora 20 virt-manager will not run on RHEL6 QEMU, throwing an error like:</p>
<blockquote>
<p>... uses a qcow2 feature which is not supported by this qemu version: QCOW version 3</p>
</blockquote>
<p>This has generated some <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1119929">user</a> <a href="https://lists.fedoraproject.org/pipermail/virt/2014-April/004040.html">confusion</a>.</p>
<p>The 'QCOW version 3' is a bit misleading here: while indeed using lazy_refcounts sets a bit in the QCOW2 file header calling it QCOW3, qemu-img and libvirt still call it QCOW2, but with a different 'compat' setting.</p>
<p>Kevin Wolf, one of the QEMU block maintainers, explains it in <a href="https://lists.fedoraproject.org/pipermail/virt/2014-April/004041.html">this mail</a>:</p>
<blockquote>
<p>qemu versions starting with 1.1 can use lazy_refcounts which require an incompatible on-disk format. Between version 1.1 and 1.6, they needed to be specified explicitly during image creation, like this:</p>
<p>qemu-img create -f qcow2 -o compat=1.1 test.qcow2 8G</p>
<p>Starting with qemu 1.7, compat=1.1 became the default, so that newly created images can't be read by older qemu versions by default. If you need to read them in older version, you now need to be explicit about using the old format:</p>
<p>qemu-img create -f qcow2 -o compat=0.10 test.qcow2 8G</p>
<p>With the same release, qemu 1.7, a new qemu-img subcommand was introduced that allows converting between both versions, so you can downgrade your existing v3 image to the format known by RHEL 6 like this</p>
<p>qemu-img amend -f qcow2 -o compat=0.10 test.qcow2</p>
</blockquote>
<p>As explained, qemu-img with QEMU 1.7+ also defaults to <code>lazy_refcounts</code>/<code>compat=1.1</code>, but also provides a <code>qemu-img amend</code> command to easily convert between the two formats.</p>
<p>Unfortunately that command is not available on Fedora 20 and older, however you can use the pre-existing 'qemu-img convert' command:</p>
<p><code>qemu-img convert -f qcow2 -O qcow2 -o compat=0.10 $ORIGPATH $NEWPATH</code></p>
<p>Beware though, converting between two qcow2 images will drop all internal snapshots in the new image, so only use that option if you don't need to preserve any snapshot data. <code>qemu-img amend</code> <u>will</u> preserve snapshot data.</p>
<p>(Unfortunately at this time virt-manager doesn't provide any way in the UI to <u>not</u> use <code>lazy_refcounts</code>, but you could always use <code>qemu-img</code> or <code>virsh</code> to create a disk image outside of virt-manager, and select it when creating a new VM.)</p>
        </div>

        <div id="disqus_thread"></div>
        <script>
          var disqus_config = function () {
            this.page.url = 'https://blog.wikichoon.com/2014/12/virt-manager-10-creates-qcow2-images.html';
            this.page.identifier = 'https://blog.wikichoon.com/2014/12/virt-manager-10-creates-qcow2-images.html';
          };

          (function() {
            var d = document, s = d.createElement('script');
            s.src = 'https://wikichoon-com.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </article>
      </div>
    </main>

    <footer class="site-footer h-card">
      <div class="wrapper">
        <h2 class="footer-heading">Cole's dev log</h2>
        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
                <li class="p-name">Cole Robinson </li><li><a class="u-email" href="mailto:">aintdiscole@gmail.com</a></li>
            </ul>
          </div>

          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li><a href="https://github.com/crobinso"><svg class="svg-icon"><use xlink:href="https://blog.wikichoon.com/theme/minima-social-icons.svg#github"></use></svg> <span class="username">crobinso</span></a></li>
              <li><a href="https://www.twitter.com/aintdiscole"><svg class="svg-icon"><use xlink:href="https://blog.wikichoon.com/theme/minima-social-icons.svg#twitter"></use></svg> <span class="username">aintdiscole</span></a></li>
              <li><a href="https://www.linkedin.com/in/cole-robinson-484a9912"><svg class="svg-icon"><use xlink:href="https://blog.wikichoon.com/theme/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Cole Robinson</span></a></li>
            </ul>
          </div>

          <div class="footer-col footer-col-3">
            <a href="https://blog.wikichoon.com/feeds/all.atom.xml">RSS</a>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>