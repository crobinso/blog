<!DOCTYPE html>
<!-- Generated 2020-07-11 20:40:33.454444 -->
<html lang="en">
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-142995745-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-142995745-1');
    </script>
    <link rel="canonical" href="https://blog.wikichoon.com/2014/11/x2apic-on-by-default-with-qemu-20-and.html"/>
      <title>x2apic on by default with qemu 2.0+, and some history | Cole Robinson</title>
      <meta charset="utf-8" />
      <link href="https://blog.wikichoon.com/theme/minima-main.css" rel="stylesheet" />
      <link href="https://blog.wikichoon.com/theme/coletheme.css" rel="stylesheet" />
      <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <link href="https://blog.wikichoon.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Cole Robinson Full Atom Feed" />
  </head>

  <body id="index" class="archive">
    <header class="site-header">
      <div class="wrapper">
        <a class="site-title" href="https://blog.wikichoon.com">Cole Robinson</a>
        <nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
          <div class="trigger">
            <a class="page-link" href="https://blog.wikichoon.com">Home</a>
            <a class="page-link" href="https://blog.wikichoon.com/archives.html">Archives</a>
            <a class="page-link" href="https://wikichoon.com">About</a>
          </div>
        </nav>
      </div>
    </header>

    <main id="content" class="page-content">
      <div class="wrapper">
      <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
        <header>
          <h1 class="post-title givemecolor" itemprop="name headline">x2apic on by default with qemu 2.0+, and some history</h2>
          <p class="post-meta">
            <time class="dt-published" datetime="2014-11-28T14:37:00-05:00" itemprop="datePublished">Fri 28 November 2014
            </time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Cole Robinson</span>
            </span> • Tags: <a href="https://blog.wikichoon.com/tag/fedora.html">fedora</a> <a href="https://blog.wikichoon.com/tag/virt.html">virt</a>           </p>
        </header>

        <div class="post-content" itemprop="articleBody">
          <p><a href="https://en.wikipedia.org/wiki/X2APIC">x2apic</a> is a performance and scalability feature available in many modern Intel CPUs. Though regardless of whether your host CPU supports it, KVM can unconditionally emulate it for x86 guests, giving an easy performance win with no downside. This feature has existed since 2009 and been a regular recommendation for <a href="https://www.linux-kvm.org/page/Tuning_KVM">tuning a KVM VM</a>.</p>
<p>As of qemu 2.0.0 x2apic is enabled automatically (more details at the end).
Priot to that, actually benefiting from x2apic required a tool like virt-manager to explicitly enable the flag, which has had a long bumpy road.</p>
<p>x2apic is exposed on the qemu command line as a CPU feature, like: <code>qemu -cpu $MODEL,+x2apic</code></p>
<p>And there isn't any way to specify a feature flag without specifying the CPU model. So enabling x2apic required hardcoding a CPU model where traditionally tools (and libvirt) deferred to qemu's default.</p>
<p>A Fedora 13 <a href="https://fedoraproject.org/wiki/Features/Virtx2apic">feature page</a> was created to track the change, and we <a href="https://pkgs.fedoraproject.org/cgit/python-virtinst.git/commit/?id=7a684cb65d69f2b116809456bed99ed32ca44080">enabled it in python-virtinst</a> for f13/rawhide. The implementation attempted to hardcode the CPU model name that libvirt detected for the host machine, which unfortunately has some problems as I explained in a <a href="https://blog.wikichoon.com/2014/03/virt-manager-improved-cpu-model-default.html">previous post</a>. This led to some <a href="https://bugzilla.redhat.com/show_bug.cgi?id=611584">issues</a> installing 64bit guests, and after trying to hack around it, I gave up and reverted the change.</p>
<p>(In retrospect, we likely could have made it work by just trying to duplicate the default CPU model logic that qemu uses, however that might have hit issues if the CPU default ever changed, like on RHEL for example.)</p>
<p>Later on virt-manager and virt-install gained UI for enabling x2apic, but a user had to know what they were doing and hunt it down.</p>
<p>As mentioned above, as of qemu 2.0.0 any x86 KVM VM will have x2apic automatically enabled, so there's no explicit need to opt in. From <a href="https://github.com/qemu/qemu/commit/ef02ef5f4536dba090b12360a6c862ef0e57e3bc">qemu.git</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">commit</span> <span class="n">ef02ef5f4536dba090b12360a6c862ef0e57e3bc</span>
<span class="n">Author</span><span class="p">:</span> <span class="n">Eduardo</span> <span class="n">Habkost</span> <span class="o">&lt;</span><span class="n">ehabkost</span> <span class="n">redhat</span><span class="p">.</span><span class="n">com</span><span class="o">&gt;</span>
<span class="nb">Date</span><span class="p">:</span>   <span class="n">Wed</span> <span class="n">Feb</span> <span class="mi">19</span> <span class="mi">11</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">12</span> <span class="mi">2014</span> <span class="o">-</span><span class="mi">0300</span>

    <span class="n">target</span><span class="o">-</span><span class="n">i386</span><span class="p">:</span> <span class="n">Enable</span> <span class="n">x2apic</span> <span class="k">by</span> <span class="k">default</span> <span class="k">on</span> <span class="n">KVM</span>
</code></pre></div>
        </div>

        <div id="disqus_thread"></div>
        <script>
          var disqus_config = function () {
            this.page.url = 'https://blog.wikichoon.com/2014/11/x2apic-on-by-default-with-qemu-20-and.html';
            this.page.identifier = 'https://blog.wikichoon.com/2014/11/x2apic-on-by-default-with-qemu-20-and.html';
          };

          (function() {
            var d = document, s = d.createElement('script');
            s.src = 'https://wikichoon-com.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </article>
      </div>
    </main>

    <footer class="site-footer h-card">
      <div class="wrapper">
        <h2 class="footer-heading">Cole's dev log</h2>
        <div class="footer-col-wrapper">
          <div class="footer-col footer-col-1">
            <ul class="contact-list">
                <li class="p-name">Cole Robinson </li><li><a class="u-email" href="mailto:">aintdiscole@gmail.com</a></li>
            </ul>
          </div>

          <div class="footer-col footer-col-2">
            <ul class="social-media-list">
              <li><a href="https://github.com/crobinso"><svg class="svg-icon"><use xlink:href="https://blog.wikichoon.com/theme/minima-social-icons.svg#github"></use></svg> <span class="username">crobinso</span></a></li>
              <li><a href="https://www.twitter.com/aintdiscole"><svg class="svg-icon"><use xlink:href="https://blog.wikichoon.com/theme/minima-social-icons.svg#twitter"></use></svg> <span class="username">aintdiscole</span></a></li>
              <li><a href="https://www.linkedin.com/in/cole-robinson-484a9912"><svg class="svg-icon"><use xlink:href="https://blog.wikichoon.com/theme/minima-social-icons.svg#linkedin"></use></svg> <span class="username">Cole Robinson</span></a></li>
            </ul>
          </div>

          <div class="footer-col footer-col-3">
            <a href="https://blog.wikichoon.com/feeds/all.atom.xml">RSS</a>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>